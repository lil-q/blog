<!DOCTYPE html>
<html lang="en-us">

<head>
  <title>持久层与持久层框架 | Homeward</title>

  <meta charset="UTF-8">
  <meta name="language" content="en">
  <meta name="description" content="持久层框架 MyBatis">
  <meta name="keywords" content="MyBatis , 持久层 , SPI , 打破双亲委派">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  
  

  <link rel="shortcut icon" type="image/png" href="/favicon.ico" />

  
  
    
 
  
  
  
  
  
  
    
    <link type="text/css" rel="stylesheet" href="/css/post.min.ab05d5e01a9242c9472ee834dca8b5e136420f575e85e4d6d45b56022054489f.css" integrity="sha256-qwXV4BqSQslHLug03Ki14TZCD1deheTW1FtWAiBUSJ8="/>
  
    
    <link type="text/css" rel="stylesheet" href="/css/custom.min.90b5007688d9661bb8a3c179e17156ae3f54efa01088ed1cd0364235af826683.css" integrity="sha256-kLUAdojZZhu4o8F54XFWrj9U76AQiO0c0DZCNa&#43;CZoM="/>
  
  
   
   
    

<script type="application/ld+json">
  
    {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lil-q.github.io\/"
      },
      "articleSection" : "blog",
      "name" : "持久层与持久层框架",
      "headline" : "持久层与持久层框架",
      "description" : "持久层框架 MyBatis",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "2020",
      "datePublished": "2020-09-14 12:00:08 \u002b0800 CST",
      "dateModified" : "2020-09-14 12:00:08 \u002b0800 CST",
      "url" : "https:\/\/lil-q.github.io\/blog\/mybatis\/",
      "wordCount" : "542",
      "keywords" : ["MyBatis", "持久层", "SPI", "打破双亲委派", "Blog"]
    }
  
  </script>
</head>

<body>
  <div class="burger__container">
  <div class="burger" aria-controls="navigation" aria-label="Menu">
    <div class="burger__meat burger__meat--1"></div>
    <div class="burger__meat burger__meat--2"></div>
    <div class="burger__meat burger__meat--3"></div>
  </div>
</div>
 

  <nav class="nav" id="navigation">
  <ul class="nav__list">
    
    
      <li>
        <a  href="/">About</a>
      </li>
    
      <li>
        <a  class="active"
         href="/blog">技术</a>
      </li>
    
      <li>
        <a  href="/picture">相册</a>
      </li>
    
      <li>
        <a  href="/essay">随笔</a>
      </li>
    
  </ul>
</nav>


  <main>
    
    

    <div class="flex-wrapper">
      <div class="post__container">
        <div class="post">
          <header class="post__header">
            <h1 id="post__title">持久层与持久层框架</h1>
            <time datetime="2020-09-14 12:00:08 &#43;0800 CST" class="post__date">Sep 14 2020</time> 
          </header>
          <article class="post__content">
              
<p>为了保存数据，需要持久层；为了实现持久层，需要数据库；为了管理数据库，需要数据库管理系统；为了操作数据库管理系统，需要持久层框架。</p>
<h2 id="一持久层">一、持久层<a class="anchor" href="#一持久层">#</a></h2>
<p>储存在内存之上的数据在断电后就会清除，与之相对的，储存在硬盘中的数据可以长时间、安全的保存，称之为持久层。</p>
<p>企业应用中的数据（各种订单数据、客户数据、库存数据等）十分重要，所以需要把数据持久化。持久化可以通过很多方式，写文件和数据库都可以，一般会把数据持久化到数据库中，因为可以很方便的查询、统计和分析，而且数据库 ACID 特性中的持久性（durability）就是针对的持久层。</p>
<h2 id="二jdbc">二、JDBC<a class="anchor" href="#二jdbc">#</a></h2>
<p>对于 java，最开始是使用 JDBC 来进行数据库管理的。<strong>java数据库连接</strong>（<strong>J</strong>ava <strong>D</strong>atabase <strong>C</strong>onnectivity，<strong>JDBC</strong>）是 java 提供的一个操作数据库的 API。它是由各种数据库厂商提供类和接口组成的数据库驱动，为多种数据库提供统一访问，使用数据库时只需要调用 JDBC 接口就行了，大致的步骤如下：</p>
<pre><code class="language-java">public class JDBCTest {
    // JDBC driver name and database URL
    static final String JDBC_DRIVER = &quot;com.mysql.cj.jdbc.Driver&quot;;
    static final String DB_URL = &quot;jdbc:mysql://localhost:port/DB_name?...&quot;;

    // Database credentials
    static final String USER = &quot;root&quot;;
    static final String PASS = &quot;password&quot;;

    public static void main(String[] args) {
        Connection conn = null;
        Statement stmt = null;
        try{
            //STEP 1: Register JDBC driver
            Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;);

            //STEP 2: Open a connection
            conn = DriverManager.getConnection(DB_URL,USER,PASS);

            //STEP 3: Execute a query
            stmt = conn.createStatement();
            String sql = &quot;SELECT id, name FROM Employees&quot;;
            ResultSet rs = stmt.executeQuery(sql);

            //STEP 4: Extract data from result set
            while(rs.next()){
                //Retrieve by column name
                int id  = rs.getInt(&quot;id&quot;);
                String first = rs.getString(&quot;name&quot;);

                //Display values
                System.out.print(&quot;ID: &quot; + id);
                System.out.println(&quot;, name: &quot; + name);
            }
            //STEP 5: Clean-up environment
            rs.close();
            stmt.close();
            conn.close();
        }catch(SQLException se){
            //Handle errors for JDBC
            se.printStackTrace();
        }catch(Exception e){
            //Handle errors for Class.forName
            e.printStackTrace();
        }finally{
            //finally block used to close resources
            try{
                if(stmt!=null)
                    stmt.close();
            }catch(SQLException se2){
            }// nothing we can do
            try{
                if(conn!=null)
                    conn.close();
            }catch(SQLException se){
                se.printStackTrace();
            }
        }
    }
}
</code></pre>
<p>可大致总结为四个步骤：</p>
<ul>
<li>通过类加载注册特定数据库的 driver；</li>
<li>通过 URL、用户名和密码建立连接；</li>
<li>新建 SQL 语句进行查询；</li>
<li>获取结果。</li>
</ul>
<h3 id="21-spi">2.1 SPI<a class="anchor" href="#21-spi">#</a></h3>
<p>那么类加载是如何注册 driver 的呢？可以在 MySQL 的 jar 包 com.mysql.cj.jdbc 下找到 MySQL 的 Driver，其中包含静态代码块：</p>
<pre><code class="language-java">public class Driver extends NonRegisteringDriver implements java.sql.Driver {
    public Driver() throws SQLException {
    }

    static {
        try {
            // 这个函数会把创建的 driver 对象加入到 registerDrivers 这个 list 中
            DriverManager.registerDriver(new Driver());
        } catch (SQLException var1) {
            throw new RuntimeException(&quot;Can't register driver!&quot;);
        }
    }
}
</code></pre>
<p>所以<code>Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;)</code>加载时，就会创建相应的 Driver 并自动加入到 DriverManager 下的 <em>registeredDrivers</em> 这个 list 中。</p>
<pre><code class="language-java">public class DriverManager {
    
    private final static CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = new CopyOnWriteArrayList&lt;&gt;();
}
</code></pre>
<p>假如我们同时可能会用到两个数据库，则需要分别加载这两个数据库的 driver。那么当我们需要特定一个数据库时，JDBC 是如何找到特定的那个数据库的呢？</p>
<p>其实在第二步建立连接时 JDBC 会去 <em>registeredDrivers</em> 这个 list 中按照 URL 找到相对应的 driver：</p>
<pre><code class="language-java">for (DriverInfo aDriver : registeredDrivers) {
    // If the caller does not have permission to load the driver then
    // skip it.
    if (isDriverAllowed(aDriver.driver, callerCL)) {
        try {
            println(&quot;    trying &quot; + aDriver.driver.getClass().getName());
            Connection con = aDriver.driver.connect(url, info);
            if (con != null) {
                // Success!
                println(&quot;getConnection returning &quot; + aDriver.driver.getClass().getName());
                return (con);
            }
        } catch (SQLException ex) {
            if (reason == null) {
                reason = ex;
            }
        }
    } else {
        println(&quot;    skipping: &quot; + aDriver.getClass().getName());
    }
}
</code></pre>
<p>其实上面 DriverManager 管理多个数据库的 driver 就是用到了 SPI 的思想，管理者提供一个接口，服务提供商们按照接口的规范来实现功能。</p>
<blockquote>
<p><strong>Service Provider Interface</strong> (<strong>SPI</strong>) is an API intended to be implemented or extended by a third party. It can be used to enable framework extension and replaceable components.</p>
</blockquote>
<p>如果我们使用的 JDBC 版本是 4.0 及以后的版本，那么第一步的手动类加载其实可以删去，因为 JDBC 采用新的规范让 SPI 帮我们完成了这一步。我们可以在 MySQL 的 jar 包 com.mysql.cj.jdbc 下找到 META-INF.services 中的 java.sql.Driver 文件，其中记录了 MySQL 所使用的 Driver 的全限定名，DriverManager 中的 ServiceLoader 会根据这个全限定名来完成注册。</p>
<p>这里还涉及到一个与类加载相关的问题：JDBC 属于 java 提供的服务，DriverManager 的类加载器应该是 Bootstrap Class Loarder，但是 MySQL 等提供的第三方服务不应该使用这个加载器，而应该用 Application Class Loader。 为了解决这个问题，只能打破双亲委派机制了，比如使用线程上下文类加载器（Thread Context ClassLoader）。</p>
<h3 id="22-jdbc-存在的问题">2.2 JDBC 存在的问题<a class="anchor" href="#22-jdbc-存在的问题">#</a></h3>
<ul>
<li>频繁地开启和关闭数据库连接，严重地影响了数据库的性能；</li>
<li>代码中存在硬编码。每当需求变更时，都需要修改源代码然后重新编译，系统不易维护；</li>
<li>设置查询参数的过程繁琐；</li>
<li>获取查询结果的过程繁琐。</li>
</ul>
<h2 id="三orm">三、ORM<a class="anchor" href="#三orm">#</a></h2>
<blockquote>
<p><strong>ORM</strong>(<strong>O</strong>bject-<strong>R</strong>elational <strong>M</strong>apping) in computer science is a programming technique for converting data between incompatible type systems using object-oriented programming languages. This creates, in effect, a &ldquo;virtual object database&rdquo; that can be used from within the programming language.</p>
</blockquote>
<p>java 是面向对象的语言，ORM 就是建立对象与数据库表之间的关系，从而达到操作对象就相当于操作数据库表的目的，ORM 能够大大减少重复性代码。</p>
<h3 id="31-jpa">3.1 JPA<a class="anchor" href="#31-jpa">#</a></h3>
<p><strong>JPA</strong>（<strong>J</strong>ava <strong>P</strong>ersistence <strong>A</strong>PI）规范本质上就是一种 ORM 规范，JPA 并未提供 ORM 实现，仅仅提供了一些编程的 API 接口，但具体实现则由服务厂商来提供实现。常见的有：</p>
<ul>
<li>Hibernate（JBoos开源）；</li>
<li>Open JPA（apache开源）；</li>
<li>Toplink。</li>
</ul>
<h2 id="四mybatis">四、MyBatis<a class="anchor" href="#四mybatis">#</a></h2>
<p>MyBatis 和 Hibernate 都属于持久层框架，但是 MyBatis 并不是完整的 ORM 框架。Hibernate 完全可以通过对象关系模型实现对数据库的操作，拥有完整的 JavaBean 对象与数据库的映射结构来自动生成 SQL 语句。而 MyBatis 仅有基本的字段映射，对象数据的管理以及对象实际关系仍然需要通过手写 SQL 语句来实现。</p>
<p>Hibernate 数据库移植性远大于 MyBatis。 Hibernate 通过它强大的映射结构和 HQL 语言，大大降低了对象与数据库的耦合性，而Mybatis 由于需要手写 SQL 语句，因此与数据库的耦合性直接取决于程序员写 SQL 语句的方法，移植成本高。</p>
<h2 id="参考">参考<a class="anchor" href="#参考">#</a></h2>
<ol>
<li><a href="https://www.bilibili.com/video/BV1st4y1Q7zP">JDBC中的知识点</a></li>
<li><a href="https://www.jianshu.com/p/ae3debd55486">Java 持久层——JDBC，MyBatis，ORM与JPA</a></li>
<li><a href="https://www.zhihu.com/question/39454008/answer/253817938">MyBatis 和 Hibernate 的区别</a></li>
<li></li>
</ol>


              
          </article>
          

<ul class="tags__list">
    
    <li class="tag__item">
        <a class="tag__link" href="https://lil-q.github.io/tags/framework/">framework</a>
    </li></ul>

 <div class="pagination">
  
    <a class="pagination__item" href="https://lil-q.github.io/blog/spring/">
        <span class="pagination__label">Previous Post</span>
        <span class="pagination__title">Spring Framework</span>
    </a>
  

  
</div>

          
          <footer class="post__footer">
            


<div class="social-icons">
  
     
    
  
     
    
      <a class="social-icons__link" title="GitHub"
         href="https://github.com/lil-q"
         target="_blank" rel="noopener">
        <div class="social-icons__icon" style="background-image: url('https://lil-q.github.io/svg/github.svg')"></div>
      </a>
    
  
     
    
      <a class="social-icons__link" title="Email"
         href="mailto:qitiantianc137@outlook.com"
         target="_blank" rel="noopener">
        <div class="social-icons__icon" style="background-image: url('https://lil-q.github.io/svg/email.svg')"></div>
      </a>
    
     
</div>

            <p>2020 © lil-q</p>
          </footer>
          </div>
      </div>
      
      <div class="toc-container">
          
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一持久层">一、持久层</a></li>
    <li><a href="#二jdbc">二、JDBC</a>
      <ul>
        <li><a href="#21-spi">2.1 SPI</a></li>
        <li><a href="#22-jdbc-存在的问题">2.2 JDBC 存在的问题</a></li>
      </ul>
    </li>
    <li><a href="#三orm">三、ORM</a>
      <ul>
        <li><a href="#31-jpa">3.1 JPA</a></li>
      </ul>
    </li>
    <li><a href="#四mybatis">四、MyBatis</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
      </div>
      
    </div>
    

  </main>

   

  
  <script src="/js/index.min.49e4d8a384357d9b445b87371863419937ede9fa77737522ffb633073aebfa44.js" integrity="sha256-SeTYo4Q1fZtEW4c3GGNBmTft6fp3c3Ui/7YzBzrr&#43;kQ=" crossorigin="anonymous"></script>
  
  
  <script src="https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js"></script>

  
  <script src="https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js"
    data-autoloader-path="https://unpkg.com/prismjs@1.20.0/components/"></script>

  
    <script src="/js/table-of-contents.js"></script>
  


</body>

</html>
